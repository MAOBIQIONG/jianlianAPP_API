<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AppProductMapper">
	<resultMap id="productDetail" type="pd">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="ID" property="ID" jdbcType="VARCHAR" />
        <result column="PROD_NAME" property="PROD_NAME" jdbcType="VARCHAR" />
        <result column="PRICE" property="PRICE" jdbcType="VARCHAR" />
        <result column="SALE_N" property="SALE_N" jdbcType="VARCHAR" />
        <result column="EXPRESS_PRICE" property="EXPRESS_PRICE" jdbcType="VARCHAR" />
        <collection property="IMGS" column="ID" javaType="ArrayList"
			ofType="pd" select="AppProductMapper.propImgs" />
		<collection property="ATTRIBUTE" column="ID" javaType="ArrayList"
			ofType="pd" select="AppProductMapper.findAttr" />
	</resultMap>
	
	<resultMap id="pDetail" type="pd">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="ID" property="ID" jdbcType="VARCHAR" />
        <result column="PROD_NAME" property="PROD_NAME" jdbcType="VARCHAR" />
        <result column="PROD_NO" property="PROD_NO" jdbcType="VARCHAR" />
        <result column="PRICE" property="PRICE" jdbcType="VARCHAR" />
        <result column="PRODUCT_IMG" property="PRODUCT_IMG" jdbcType="VARCHAR" />
		<collection property="GUIGE" column="PROD_NO" javaType="ArrayList"
			ofType="pd" select="AppProductMapper.findGuige" />
	</resultMap>
	
	<!-- 查询商品列表 -->
	<select id="findList" parameterType="pd" resultType="pd">
		select
			 a.ID,
			 a.PROD_NAME,
			 a.MAX_PRICE,
			 a.MIN_PRICE,
			 a.PROD_NO,
			(SELECT IMG_PATH FROM s_app_product_img WHERE ORDERBY='1' and PRODUCT_ID = a.id) PRODUCT_IMG
		from s_app_product a 
		where 
			a.STATUS='00' 
			and a.ID IN (
				select PROD_ID from s_app_product_shop where USER_ID=#{USER_ID}
				 AND SHOP_ID=#{SHOP_ID}
			)
		order by a.CREATE_DATE desc
		
		limit #{PAGENO},#{PAGESIZE}


	</select>
	
	<!-- 空购物车最热销三款商品查询 -->
	<select id="findHotProduct" parameterType="pd" resultType="pd">
		select
			 a.ID,
			 a.PROD_NAME,
			 a.MAX_PRICE,
			 a.MIN_PRICE,
			(SELECT IMG_PATH FROM s_app_product_img WHERE ORDERBY='1' and PRODUCT_ID = a.id) PRODUCT_IMG
		from s_app_product a 
		where 
			a.STATUS='00' 
			and a.ID IN (
				select id from s_app_product_shop where USER_ID=#{USER_ID}
				 AND SHOP_ID=#{SHOP_ID}
			)
	    ORDER BY a.SALE_N DESC LIMIT 0,3
	</select>
	
	<!-- 查询商品详情 -->
	<select id="findDetail" parameterType="pd" resultMap="productDetail">
		select
			 a.ID,
			 a.PROD_NO,
			 a.PROD_NAME,
			 a.PRICE,
			 a.SALE_N,
			 a.EXPRESS_PRICE,
       		 b.SHOP_ID
		from s_app_product a LEFT JOIN s_app_product_shop b on a.ID=b.PROD_ID
		where a.ID = #{ID} AND b.SHOP_ID=#{SHOP_ID}
	</select>
	
	
	<!-- 查询商品型号详情 -->
	<select id="findXDetail" parameterType="pd" resultMap="pDetail">
		select
			 a.ID,
			 a.PROD_NO,
			 a.PROD_NAME,
			(SELECT IMG_PATH FROM s_app_product_img WHERE ORDERBY='1' and PRODUCT_ID = a.id) PRODUCT_IMG,
		     a.PRICE
		from s_app_product a 
		where a.ID = #{ID}
	</select>
	
	<!-- 查询商品图片 -->
	<select id="propImgs" parameterType="pd" resultType="pd">
		select
			IMG_PATH,
			ORDERBY
		from s_app_product_img
		where PRODUCT_ID=#{ID}
		ORDER BY ORDERBY LIMIT 0,6
	</select>
	
	<!-- 查询商品属性 -->
	<select id="findAttr" parameterType="pd" resultType="pd">
		select
			PROP_NAME,PROP_VALUE
		from s_app_product_prop
		where PRODUCT_ID=#{ID}
		ORDER BY ORDERBY 
	</select>
	
	
	<!-- 查询商品规格-->
	<select id="findGuige" parameterType="pd" resultType="pd">
		SELECT PROD_SPEC_NAME,PROD_SPEC_VALUE FROM s_app_product_spec 
 		WHERE PROD_SPEC_ID='GUIGE' and PROD_ID=#{PROD_NO} order by ORDERBY;
	</select>
	
	<!-- 根据商品id与sku识别码查询商品价格与库存信息-->
	<select id="findShopBySku" parameterType="pd" resultType="pd">
		SELECT ID,SKU_INFO,PRICE,STOCK_N,SALES_PRICE,SALE_N FROM s_app_product_sku
		where PROD_ID=#{PROD_NO} and SKU_INFO=#{SKU_INFO}
	</select>
	
	
	<!--修改商品sku已售数量  相加-->
	<update id="editProSkuNumi" parameterType="pd">
		UPDATE s_app_product_sku set SALE_N=SALE_N+#{PROD_NUM} where SKU_INFO=#{PROD_SKUINFO} and PROD_ID=#{PROD_NO}
	</update>
	
	<!--修改商品sku已售数量  相减-->
	<update id="editProSkuNumd" parameterType="pd">
		UPDATE s_app_product_sku set SALE_N=SALE_N-#{PROD_NUM} where SKU_INFO=#{PROD_SKUINFO} and PROD_ID=#{PROD_NO}
	</update>
	
	
	<!--修改商品已售数量  相加-->
	<update id="editProNumi" parameterType="pd">
		UPDATE s_app_product set SALE_N=SALE_N+#{PROD_NUM} where PROD_NO=#{PROD_NO}
	</update>
	
	<!--修改商品已售数量  相减-->
	<update id="editProNumd" parameterType="pd">
		UPDATE s_app_product set SALE_N=SALE_N-#{PROD_NUM} where PROD_NO=#{PROD_NO}
	</update>
	
</mapper>